name: Changesets Renovate

on:
  merge_group:
  pull_request_target:
    paths:
      - '**/package.json'
      - '**/pnpm-lock.yaml'
      - '.github/**/*.yaml'

permissions:
  contents: write

jobs:
  changesets-renovate:
    if: ${{ github.actor == 'renovate[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 2
          ref: ${{ github.head_ref }}
      - name: Setup
        uses: ./.github/actions/setup
      - name: Generate Changeset for Renovate
        # language=bash
        run: |
          SKIP_COMMIT=TRUE pnpx @scaleway/changesets-renovate
          pnpm turbo run build --filter @apitree.cz/prettier-config
          pnpm prettier --write .changeset/**/*.md
      - name: Commit and Push Changeset
        # language=bash
        run: |
          git config user.name "renovate[bot]"
          git config user.email "29139614+renovate[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git add .changeset/**/*.md
          git commit -m "chore(renovate): add changeset" || echo "No changes to commit"
          git push
