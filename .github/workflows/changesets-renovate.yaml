name: Changesets Renovate

on:
  merge_group:
  pull_request_target:
    paths:
      - '**/package.json'
      - '**/pnpm-lock.yaml'
      - '.github/**/*.yaml'

permissions:
  contents: write

jobs:
  changesets-renovate:
    if: ${{ github.actor == 'renovate[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
      - name: Setup
        uses: ./.github/actions/setup
      - name: Generate Changeset for Renovate
        env:
          SKIP_COMMIT: TRUE
        # language=bash
        run: |
          # Skip if the only package.json file changed is the root one
          CHANGED_PACKAGE_JSONS=$(git diff --name-only "origin/$GITHUB_BASE_REF...HEAD" -- 'package.json' 'packages/*/package.json')
          WORKSPACE_PACKAGE_JSONS=$(echo "$CHANGED_PACKAGE_JSONS" | grep -v '^package\.json$' || echo "")

          if [ -z "$WORKSPACE_PACKAGE_JSONS" ]; then
            echo "Only root package.json changed, skipping changeset generation"
            exit 0
          fi

          # Generate changeset
          pnpx @scaleway/changesets-renovate
          pnpm turbo run build --filter @apitree.cz/prettier-config
          pnpm prettier --write .changeset/**/*.md
      - name: Commit and Push Changeset
        # language=bash
        run: |
          git config user.name "renovate[bot]"
          git config user.email "29139614+renovate[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git add .changeset
          git commit -m "chore(renovate): add changeset" || echo "No changes to commit"
          git push
